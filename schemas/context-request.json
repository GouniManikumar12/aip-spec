{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "ContextRequest",
  "description": "Normalized request sent from an AIP operator to Brand Agents to request bids. UCP (User Context Protocol) aligned structure with flat top-level and single nested context object. Note: message_id MUST equal context.context_id (enforced invariant).",
  "type": "object",
  "required": [
    "spec_version",
    "message_id",
    "timestamp",
    "producer",
    "context",
    "consent",
    "usage_constraints",
    "session_id",
    "turn_index"
  ],
  "properties": {
    "spec_version": {
      "type": "string",
      "description": "UCP specification version",
      "example": "aip/1.0"
    },
    "message_id": {
      "type": "string",
      "description": "Unique message ID for this context request. MUST equal context.context_id (enforced invariant).",
      "example": "ctx_92fA1"
    },
    "timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "ISO timestamp of the event",
      "example": "2025-11-14T18:22:00Z"
    },
    "producer": {
      "type": "object",
      "required": ["agent_id", "agent_role", "software", "software_version"],
      "properties": {
        "agent_id": {
          "type": "string",
          "description": "Identifier of the operator sending this request",
          "example": "admesh_operator"
        },
        "agent_role": {
          "type": "string",
          "description": "Role of the agent, typically 'seller' for operators",
          "example": "seller"
        },
        "software": {
          "type": "string",
          "description": "Software name",
          "example": "admesh_operator"
        },
        "software_version": {
          "type": "string",
          "description": "Software version",
          "example": "1.0.0"
        }
      }
    },
    "session_id": {
      "type": "string",
      "description": "Conversation/session identifier",
      "example": "sess_001"
    },
    "conversation_id": {
      "type": "string",
      "description": "Optional conversation session from platform",
      "example": "conv_xyz789"
    },
    "turn_index": {
      "type": "integer",
      "minimum": 0,
      "description": "How many turns into the session the user is",
      "example": 3
    },
    "latency_budget_ms": {
      "type": "integer",
      "description": "How long the platform will wait for an ad response (milliseconds)",
      "example": 500
    },
    "allowed_formats": {
      "type": "array",
      "description": "Creative formats allowed by the operator for rendering",
      "items": {
        "type": "string",
        "enum": ["weave", "tail", "product_card", "bridge", "citation"]
      },
      "example": ["weave", "citation", "product_card"]
    },
    "context": {
      "type": "object",
      "required": ["context_id", "language", "publisher", "placement", "device", "geography", "intent", "verticals"],
      "properties": {
        "context_id": {
          "type": "string",
          "description": "Unique context ID for this auction request. MUST equal message_id (enforced invariant).",
          "example": "ctx_92fA1"
        },
        "language": {
          "type": "string",
          "pattern": "^[a-z]{2}-[A-Z]{2}$",
          "description": "User locale in BCP 47 format",
          "example": "en-US"
        },
        "publisher": {
          "type": "string",
          "description": "Identifier of the source AI platform",
          "example": "openai_chat"
        },
        "placement": {
          "type": "object",
          "required": ["ad_unit"],
          "properties": {
            "ad_unit": {
              "type": "string",
              "description": "Platform surface type: chat, voice, browser, extension, ui panel, etc.",
              "example": "conversation"
            }
          }
        },
        "device": {
          "type": "object",
          "required": ["platform", "form_factor"],
          "properties": {
            "platform": {
              "type": "string",
              "description": "Device platform: web, mobile, etc.",
              "example": "web"
            },
            "form_factor": {
              "type": "string",
              "enum": ["mobile", "desktop", "tablet"],
              "description": "Device form factor",
              "example": "desktop"
            }
          }
        },
        "geography": {
          "type": "object",
          "required": ["country"],
          "properties": {
            "country": {
              "type": "string",
              "pattern": "^[A-Z]{2}$",
              "description": "User country code (ISO 3166-1 alpha-2)",
              "example": "US"
            }
          }
        },
        "intent": {
          "type": "object",
          "required": ["type", "decision_phase", "confidence", "summary"],
          "properties": {
            "type": {
              "type": "string",
              "enum": ["informational", "commercial", "transactional"],
              "description": "High-level intent classification",
              "example": "commercial"
            },
            "decision_phase": {
              "type": "string",
              "enum": ["awareness", "consideration", "compare", "decision"],
              "description": "Commercial funnel decision phase",
              "example": "compare"
            },
            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Confidence score for intent classification",
              "example": 0.87
            },
            "summary": {
              "type": "string",
              "description": "Short operator-generated summary of the relevant conversation context (sanitized, no raw queries)",
              "example": "User is comparing CRM tools for a small team."
            }
          }
        },
        "verticals": {
          "type": "array",
          "description": "Normalized topical verticals identified by the operator",
          "items": {
            "type": "string"
          },
          "example": ["crm", "smb_software"]
        }
      }
    },
    "embeddings": {
      "type": "array",
      "description": "Array of embedding vectors (optional, may be added by operator)",
      "items": {
        "type": "object",
        "required": ["id", "type", "dimension", "origin"],
        "properties": {
          "id": {
            "type": "string",
            "description": "Embedding identifier",
            "example": "emb_intent"
          },
          "type": {
            "type": "string",
            "description": "Embedding type",
            "example": "user_intent"
          },
          "dimension": {
            "type": "integer",
            "description": "Embedding dimension",
            "example": 256
          },
          "origin": {
            "type": "object",
            "properties": {
              "text_window": {
                "type": "string",
                "description": "Text used to generate embedding",
                "example": "CRM comparison for small teams"
              },
              "on_device": {
                "type": "boolean",
                "description": "Whether embedding was generated on device",
                "example": false
              }
            }
          }
        }
      }
    },
    "consent": {
      "type": "object",
      "required": ["purposes", "permissible_uses", "ttl_seconds", "legal_basis"],
      "properties": {
        "purposes": {
          "type": "array",
          "description": "List of consent purposes",
          "items": {
            "type": "string"
          },
          "example": ["activation_scoring"]
        },
        "permissible_uses": {
          "type": "array",
          "description": "List of permissible uses",
          "items": {
            "type": "string"
          },
          "example": ["activation_scoring"]
        },
        "ttl_seconds": {
          "type": "integer",
          "description": "Time to live in seconds",
          "example": 900
        },
        "legal_basis": {
          "type": "string",
          "description": "Legal basis for consent",
          "example": "contract"
        }
      }
    },
    "usage_constraints": {
      "type": "object",
      "required": ["disallowed"],
              "properties": {
                "disallowed": {
                  "type": "array",
                  "description": "List of disallowed uses",
                  "items": {
                    "type": "string"
                  },
          "example": ["retargeting", "profiling", "storage", "cross_session_learning", "identity_resolution"]
            }
          }
    }
  },
  "examples": [
    {
      "spec_version": "aip/1.0",
      "message_id": "ctx_92fA1",
      "timestamp": "2025-11-14T18:22:00Z",
      "producer": {
        "agent_id": "admesh_operator",
        "agent_role": "seller",
        "software": "admesh_operator",
        "software_version": "1.0.0"
      },
      "session_id": "sess_001",
      "conversation_id": "conv_xyz789",
      "turn_index": 3,
      "latency_budget_ms": 500,
      "allowed_formats": ["weave", "citation", "product_card"],
      "context": {
        "context_id": "ctx_92fA1",
        "language": "en-US",
        "publisher": "openai_chat",
        "placement": {
          "ad_unit": "conversation"
        },
        "device": {
          "platform": "web",
          "form_factor": "desktop"
        },
        "geography": {
          "country": "US"
        },
        "intent": {
          "type": "commercial",
          "decision_phase": "compare",
          "confidence": 0.87,
          "summary": "User is comparing CRM tools for a small team."
        },
        "verticals": ["crm", "smb_software"]
      },
      "embeddings": [
        {
          "id": "emb_intent",
          "type": "user_intent",
          "dimension": 256,
          "origin": {
            "text_window": "CRM comparison for small teams",
            "on_device": false
          }
        }
      ],
      "consent": {
        "purposes": ["activation_scoring"],
        "permissible_uses": ["activation_scoring"],
        "ttl_seconds": 900,
        "legal_basis": "contract"
      },
          "usage_constraints": {
            "disallowed": [
              "retargeting",
              "profiling",
              "storage",
          "cross_session_learning",
          "identity_resolution"
            ]
      }
    }
  ],
  "$id": "https://aip.org/schemas/context-request.json"
}
